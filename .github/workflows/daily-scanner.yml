name: Daily EVR Scanner

on:
  schedule:
    # Run daily at 6:00 AM ET (10:00 AM UTC during EDT, 11:00 AM UTC during EST)
    # Using 10:00 UTC to hit 6AM EDT (most of trading year: March-November)
    # During EST (winter), this will be 5AM ET, still before market open
    - cron: '0 10 * * 1-5'  # Monday to Friday at 10:00 AM UTC = 6:00 AM EDT
  workflow_dispatch:  # Allow manual trigger

jobs:
  daily-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-python-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-python-
    
    - name: Cache ticker data
      uses: actions/cache@v4
      with:
        path: |
          cache/
          trained_parameters/
        key: ${{ runner.os }}-evr-cache-${{ github.run_number }}
        restore-keys: |
          ${{ runner.os }}-evr-cache-
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: Install dependencies
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install pandas numpy pyarrow yfinance requests rich matplotlib jinja2 seaborn lxml html5lib
    
    - name: Check cache status
      run: |
        echo "Cache directories:"
        ls -lah cache/ 2>/dev/null || echo "No cache directory yet (will be created by scanner)"
        ls -lah trained_parameters/ 2>/dev/null || echo "No trained_parameters directory yet"
        echo ""
        echo "This workflow uses cache to persist:"
        echo "  - Ticker lists (cache/official_tickers.json, cache/delisted_tickers.json)"
        echo "  - Trained parameters (trained_parameters/)"
        echo "  - Python dependencies (.venv/)"
        
    - name: Run EVR Scanner
      run: |
        source .venv/bin/activate
        python official_scanner.py \
          --top 30 \
          --output-prefix "daily_$(date +%Y%m%d)" \
          --log-level INFO \
          --max-holding-days 7 \
          --enable-replacement \
          --replacement-threshold 0.20
        
    - name: Generate Portfolio Report
      run: |
        source .venv/bin/activate
        python -c "
        import json
        from datetime import datetime
        
        # Read portfolio state
        with open('portfolio_state.json', 'r') as f:
            portfolio = json.load(f)
        
        # Generate report
        report = []
        report.append('=' * 70)
        report.append('EVR DAILY PORTFOLIO REPORT')
        report.append('=' * 70)
        report.append(f'Generated: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}')
        report.append('')
        
        # Portfolio Summary
        report.append('PORTFOLIO SUMMARY')
        report.append('-' * 70)
        report.append(f'Total Capital:        \${portfolio[\"total_capital\"]:,.2f}')
        report.append(f'Available Capital:    \${portfolio[\"available_capital\"]:,.2f} ({portfolio[\"available_capital\"]/portfolio[\"total_capital\"]*100:.1f}%)')
        report.append(f'Allocated Capital:    \${portfolio[\"allocated_capital\"]:,.2f} ({portfolio[\"allocated_capital\"]/portfolio[\"total_capital\"]*100:.1f}%)')
        report.append(f'Total P&L:            \${portfolio[\"total_pnl\"]:+,.2f}')
        report.append(f'Total Return:         {portfolio[\"total_return_pct\"]*100:+.2f}%')
        report.append(f'Run Count:            {portfolio[\"run_count\"]}')
        report.append(f'Last Updated:         {portfolio[\"last_updated\"]}')
        report.append('')
        
        # Open Positions
        open_positions = [p for p in portfolio['positions'] if p['status'] == 'OPEN']
        closed_positions = [p for p in portfolio['positions'] if p['status'] != 'OPEN']
        
        report.append(f'OPEN POSITIONS ({len(open_positions)})')
        report.append('-' * 70)
        
        if open_positions:
            for i, pos in enumerate(open_positions, 1):
                report.append(f'{i}. {pos[\"ticker\"]} ({pos[\"setup\"]})')
                report.append(f'   Entry: \${pos[\"entry_price\"]:.2f} | Stop: \${pos[\"stop_price\"]:.2f} | Target: \${pos[\"target_prices\"][0]:.2f}')
                report.append(f'   Shares: {pos[\"shares\"]} | Position Size: \${pos[\"position_size\"]:.2f}')
                report.append(f'   P(Win): {pos[\"p_win\"]*100:.1f}% | Expected Return: {pos[\"expected_return\"]*100:.2f}% | Risk: \${pos[\"risk_dollars\"]:.2f}')
                entry_date = datetime.fromisoformat(pos['entry_date'])
                days_held = (datetime.now() - entry_date).days
                report.append(f'   Entry Date: {entry_date.strftime(\"%Y-%m-%d %H:%M\")} ({days_held} days ago)')
                report.append('')
        else:
            report.append('No open positions.')
            report.append('')
        
        # Recently Closed Positions
        if closed_positions:
            recent_closed = sorted(closed_positions, key=lambda x: x.get('exit_date', ''), reverse=True)[:5]
            report.append(f'RECENTLY CLOSED POSITIONS (Last {len(recent_closed)})')
            report.append('-' * 70)
            for pos in recent_closed:
                pnl_str = f\"\${pos['pnl']:+,.2f}\" if pos.get('pnl') else 'N/A'
                return_str = f\"{pos['return_pct']*100:+.2f}%\" if pos.get('return_pct') else 'N/A'
                report.append(f'{pos[\"ticker\"]} ({pos[\"setup\"]}) - {pos[\"status\"]}')
                report.append(f'   Entry: \${pos[\"entry_price\"]:.2f} â†’ Exit: \${pos.get(\"exit_price\", 0):.2f}')
                report.append(f'   P&L: {pnl_str} | Return: {return_str}')
                if pos.get('exit_date'):
                    report.append(f'   Exit Date: {pos[\"exit_date\"]}')
                report.append('')
        
        # Performance Stats
        if closed_positions:
            wins = [p for p in closed_positions if p.get('pnl', 0) > 0]
            losses = [p for p in closed_positions if p.get('pnl', 0) <= 0]
            win_rate = len(wins) / len(closed_positions) * 100 if closed_positions else 0
            
            report.append('PERFORMANCE STATISTICS')
            report.append('-' * 70)
            report.append(f'Total Closed:         {len(closed_positions)}')
            report.append(f'Wins:                 {len(wins)}')
            report.append(f'Losses:               {len(losses)}')
            report.append(f'Win Rate:             {win_rate:.1f}%')
            report.append('')
        
        report.append('=' * 70)
        report.append('Generated by EVR Scanner GitHub Action (Daily Schedule)')
        report.append('=' * 70)
        
        # Write report
        with open('portfolio_report.txt', 'w') as f:
            f.write('\n'.join(report))
        
        print('Portfolio report generated successfully.')
        " || echo "Error generating portfolio report. Portfolio state may not exist yet."
        
    - name: Upload scan results
      uses: actions/upload-artifact@v4
      with:
        name: daily-scan-results-${{ github.run_number }}
        path: |
          scans/daily_*.csv
          scans/daily_*.json
          scans/daily_*.txt
          portfolio_report.txt
          portfolio_state.json
        retention-days: 30
        
    - name: Send daily email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "EVR Daily Portfolio Report - Run #${{ github.run_number }}"
        to: anshuman264@gmail.com
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          EVR Daily Portfolio Report
          
          Your daily portfolio scan completed successfully.
          
          **Key Highlights:**
          - Portfolio monitored for time exits (7 days max hold)
          - Position replacement evaluated (20% threshold)
          - Stop losses and targets checked
          - New opportunities scanned
          
          **Report Contents:**
          ðŸ“Š Portfolio Summary (capital, P&L, returns)
          ðŸ“ Open Positions (entry, stop, target, days held)
          âœ… Recently Closed Positions (P&L, exit reason)
          ðŸ“ˆ Performance Statistics (win rate, closed trades)
          
          **Please review the attached portfolio report for complete details.**
          
          Repository: https://github.com/${{ github.repository }}
          Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Full scan results (CSV/JSON) are available in GitHub Actions artifacts.
          
          ---
          Generated by EVR Scanner at 6:00 AM ET
        attachments: portfolio_report.txt
        content_type: text/html
        
    - name: Create GitHub Issue on Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `EVR Daily Scanner Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The daily EVR scanner failed to run on ${new Date().toISOString().split('T')[0]}.
            
            **Workflow Details:**
            - Run ID: ${context.runId}
            - Run Number: ${context.runNumber}
            - Commit: ${context.sha}
            - Branch: ${context.ref}
            
            **Please check:**
            1. Scanner dependencies
            2. Network connectivity
            3. Data source availability
            4. GitHub Actions logs
            
            **Workflow URL:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            This issue was automatically created by the EVR Scanner workflow.`,
            labels: ['bug', 'scanner', 'automation', 'daily']
          });
          
          console.log(`Created issue ${issue.data.number}: ${issue.data.title}`);
          
    - name: Notify on Failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "EVR Daily Scanner Failed - ${{ github.run_number }}"
        to: anshuman264@gmail.com
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          EVR Daily Scanner Failure Notification
          
          The daily EVR scanner failed to run.
          
          **Details:**
          - Run ID: ${{ github.run_id }}
          - Run Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref }}
          
          **Please check:**
          1. Scanner dependencies
          2. Network connectivity
          3. Data source availability
          4. GitHub Actions logs
          
          **Workflow URL:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          Generated by EVR Scanner GitHub Action
        content_type: text/html