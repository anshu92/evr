name: Daily EVR Scanner

on:
  schedule:
    # Run daily at 6:00 AM ET (10:00 AM UTC during EDT, 11:00 AM UTC during EST)
    # Using 10:00 UTC to hit 6AM EDT (most of trading year: March-November)
    # During EST (winter), this will be 5AM ET, still before market open
    - cron: '0 10 * * 1-5'  # Monday to Friday at 10:00 AM UTC = 6:00 AM EDT
  workflow_dispatch:  # Allow manual trigger

jobs:
  daily-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-python-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-python-
    
    - name: Cache ticker data
      uses: actions/cache@v4
      with:
        path: |
          cache/
          trained_parameters/
        key: ${{ runner.os }}-evr-cache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-evr-cache-${{ github.ref_name }}-
          ${{ runner.os }}-evr-cache-
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: Install dependencies
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install pandas numpy pyarrow yfinance requests rich matplotlib jinja2 seaborn lxml html5lib
    
    - name: Check cache status
      run: |
        echo "Cache directories:"
        ls -lah cache/ 2>/dev/null || echo "No cache directory yet (will be created by scanner)"
        ls -lah trained_parameters/ 2>/dev/null || echo "No trained_parameters directory yet"
        echo ""
        echo "This workflow uses cache to persist:"
        echo "  - Ticker lists (cache/official_tickers.json, cache/delisted_tickers.json)"
        echo "  - Trained parameters (trained_parameters/)"
        echo "  - Python dependencies (.venv/)"
        
    - name: Run EVR Scanner
      run: |
        source .venv/bin/activate
        python official_scanner.py \
          --top 30 \
          --output-prefix "daily_$(date +%Y%m%d)" \
          --log-level INFO \
          --max-holding-days 7 \
          --enable-replacement \
          --replacement-threshold 0.20
        
    - name: Generate Portfolio Report
      run: |
        source .venv/bin/activate
        python -c "
        import json
        import glob
        from datetime import datetime
        
        # Read portfolio state
        with open('portfolio_state.json', 'r') as f:
            portfolio = json.load(f)
        
        # Read latest scan results
        scan_files = glob.glob('scans/daily_*.json')
        recommendations = []
        if scan_files:
            latest_scan = max(scan_files, key=lambda x: x.split('_')[-1])
            with open(latest_scan, 'r') as f:
                recommendations = json.load(f)
        
        # Generate report
        report = []
        report.append('=' * 70)
        report.append('EVR DAILY PORTFOLIO REPORT & ACTION PLAN')
        report.append('=' * 70)
        report.append(f'Generated: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}')
        report.append('')
        
        # ACTION ITEMS SECTION - FIRST!
        report.append('‚ö° RECOMMENDED ACTIONS')
        report.append('=' * 70)
        
        actions = []
        action_num = 1
        
        # Get open positions
        open_positions = [p for p in portfolio['positions'] if p['status'] == 'OPEN']
        
        # 1. Check for positions to sell (time exits, near stops, etc.)
        for pos in open_positions:
            entry_date = datetime.fromisoformat(pos['entry_date'])
            days_held = (datetime.now() - entry_date).days
            
            # Flag positions near time exit (6+ days)
            if days_held >= 6:
                actions.append({
                    'type': 'SELL',
                    'ticker': pos['ticker'],
                    'shares': pos['shares'],
                    'reason': f'Time exit (held {days_held} days)',
                    'priority': 'HIGH' if days_held >= 7 else 'MEDIUM',
                    'price': pos['entry_price']
                })
            
            # Flag positions with low expected return
            if pos.get('expected_return', 0) < 0.03:  # Less than 3%
                actions.append({
                    'type': 'REVIEW',
                    'ticker': pos['ticker'],
                    'shares': pos['shares'],
                    'reason': f'Low expected return ({pos[\"expected_return\"]*100:.1f}%)',
                    'priority': 'LOW',
                    'price': pos['entry_price']
                })
        
        # 2. Check for positions to buy from recommendations
        available_cash = portfolio['available_capital']
        position_slots = 5 - len(open_positions)
        
        if recommendations and position_slots > 0:
            # Get top recommendations not already in portfolio
            open_tickers = {p['ticker'] for p in open_positions}
            new_recs = [r for r in recommendations if r.get('ticker') not in open_tickers][:position_slots]
            
            for rec in new_recs:
                if rec.get('action') in ['BUY', 'SHORT']:
                    entry_price = rec.get('entry_price', 0)
                    stop_loss = rec.get('stop_loss', entry_price * 0.95)
                    risk_per_share = abs(entry_price - stop_loss)
                    
                    # Calculate shares based on risk (2.5% of available capital)
                    max_risk = available_cash * 0.025
                    shares = int(max_risk / risk_per_share) if risk_per_share > 0 else 0
                    cost = shares * entry_price
                    
                    if shares > 0 and cost <= available_cash:
                        actions.append({
                            'type': 'BUY',
                            'ticker': rec['ticker'],
                            'shares': shares,
                            'reason': f'EVR Score: {rec.get(\"evr_score\", 0):.3f}, {rec.get(\"total_signals\", 0)} signals',
                            'priority': 'HIGH' if rec.get('evr_score', 0) > 0.7 else 'MEDIUM',
                            'price': entry_price,
                            'stop': stop_loss,
                            'target': rec.get('take_profit', entry_price * 1.1)
                        })
                        available_cash -= cost
        
        # Sort actions by priority and type
        priority_order = {'HIGH': 0, 'MEDIUM': 1, 'LOW': 2}
        actions.sort(key=lambda x: (priority_order.get(x['priority'], 3), x['type']))
        
        # Display actions
        if actions:
            for action in actions:
                priority_symbol = 'üî¥' if action['priority'] == 'HIGH' else 'üü°' if action['priority'] == 'MEDIUM' else 'üü¢'
                
                if action['type'] == 'SELL':
                    report.append(f\"{action_num}. {priority_symbol} SELL {action['shares']} shares of {action['ticker']}\")
                    report.append(f\"   Reason: {action['reason']}\")
                    report.append(f\"   Current Entry: \${action['price']:.2f}\")
                    report.append('')
                    action_num += 1
                    
                elif action['type'] == 'BUY':
                    report.append(f\"{action_num}. {priority_symbol} BUY {action['shares']} shares of {action['ticker']}\")
                    report.append(f\"   Entry: \${action['price']:.2f} | Stop: \${action['stop']:.2f} | Target: \${action['target']:.2f}\")
                    report.append(f\"   Reason: {action['reason']}\")
                    report.append(f\"   Cost: \${action['shares'] * action['price']:.2f}\")
                    report.append('')
                    action_num += 1
                    
                elif action['type'] == 'REVIEW':
                    report.append(f\"{action_num}. {priority_symbol} REVIEW {action['ticker']} position\")
                    report.append(f\"   Reason: {action['reason']}\")
                    report.append('')
                    action_num += 1
        else:
            report.append('‚úÖ No immediate actions required.')
            report.append('   Portfolio is optimally allocated.')
            report.append('')
        
        report.append('')
        
        # Portfolio Summary
        report.append('PORTFOLIO SUMMARY')
        report.append('-' * 70)
        report.append(f'Total Capital:        \${portfolio[\"total_capital\"]:,.2f}')
        report.append(f'Available Capital:    \${portfolio[\"available_capital\"]:,.2f} ({portfolio[\"available_capital\"]/portfolio[\"total_capital\"]*100:.1f}%)')
        report.append(f'Allocated Capital:    \${portfolio[\"allocated_capital\"]:,.2f} ({portfolio[\"allocated_capital\"]/portfolio[\"total_capital\"]*100:.1f}%)')
        report.append(f'Total P&L:            \${portfolio[\"total_pnl\"]:+,.2f}')
        report.append(f'Total Return:         {portfolio[\"total_return_pct\"]*100:+.2f}%')
        report.append(f'Run Count:            {portfolio[\"run_count\"]}')
        report.append(f'Last Updated:         {portfolio[\"last_updated\"]}')
        report.append('')
        
        # Open Positions
        open_positions = [p for p in portfolio['positions'] if p['status'] == 'OPEN']
        closed_positions = [p for p in portfolio['positions'] if p['status'] != 'OPEN']
        
        report.append(f'OPEN POSITIONS ({len(open_positions)})')
        report.append('-' * 70)
        
        if open_positions:
            for i, pos in enumerate(open_positions, 1):
                report.append(f'{i}. {pos[\"ticker\"]} ({pos[\"setup\"]})')
                report.append(f'   Entry: \${pos[\"entry_price\"]:.2f} | Stop: \${pos[\"stop_price\"]:.2f} | Target: \${pos[\"target_prices\"][0]:.2f}')
                report.append(f'   Shares: {pos[\"shares\"]} | Position Size: \${pos[\"position_size\"]:.2f}')
                report.append(f'   P(Win): {pos[\"p_win\"]*100:.1f}% | Expected Return: {pos[\"expected_return\"]*100:.2f}% | Risk: \${pos[\"risk_dollars\"]:.2f}')
                entry_date = datetime.fromisoformat(pos['entry_date'])
                days_held = (datetime.now() - entry_date).days
                report.append(f'   Entry Date: {entry_date.strftime(\"%Y-%m-%d %H:%M\")} ({days_held} days ago)')
                report.append('')
        else:
            report.append('No open positions.')
            report.append('')
        
        # Recently Closed Positions
        if closed_positions:
            recent_closed = sorted(closed_positions, key=lambda x: x.get('exit_date', ''), reverse=True)[:5]
            report.append(f'RECENTLY CLOSED POSITIONS (Last {len(recent_closed)})')
            report.append('-' * 70)
            for pos in recent_closed:
                pnl_str = f\"\${pos['pnl']:+,.2f}\" if pos.get('pnl') else 'N/A'
                return_str = f\"{pos['return_pct']*100:+.2f}%\" if pos.get('return_pct') else 'N/A'
                report.append(f'{pos[\"ticker\"]} ({pos[\"setup\"]}) - {pos[\"status\"]}')
                report.append(f'   Entry: \${pos[\"entry_price\"]:.2f} ‚Üí Exit: \${pos.get(\"exit_price\", 0):.2f}')
                report.append(f'   P&L: {pnl_str} | Return: {return_str}')
                if pos.get('exit_date'):
                    report.append(f'   Exit Date: {pos[\"exit_date\"]}')
                report.append('')
        
        # Performance Stats
        if closed_positions:
            wins = [p for p in closed_positions if p.get('pnl', 0) > 0]
            losses = [p for p in closed_positions if p.get('pnl', 0) <= 0]
            win_rate = len(wins) / len(closed_positions) * 100 if closed_positions else 0
            
            report.append('PERFORMANCE STATISTICS')
            report.append('-' * 70)
            report.append(f'Total Closed:         {len(closed_positions)}')
            report.append(f'Wins:                 {len(wins)}')
            report.append(f'Losses:               {len(losses)}')
            report.append(f'Win Rate:             {win_rate:.1f}%')
            report.append('')
        
        report.append('=' * 70)
        report.append('Generated by EVR Scanner GitHub Action (Daily Schedule)')
        report.append('=' * 70)
        
        # Write report
        with open('portfolio_report.txt', 'w') as f:
            f.write('\n'.join(report))
        
        print('Portfolio report generated successfully.')
        " || echo "Error generating portfolio report. Portfolio state may not exist yet."
        
    - name: Upload scan results
      uses: actions/upload-artifact@v4
      with:
        name: daily-scan-results-${{ github.run_number }}
        path: |
          scans/daily_*.csv
          scans/daily_*.json
          scans/daily_*.txt
          portfolio_report.txt
          portfolio_state.json
        retention-days: 30
        
    - name: Check email configuration
      run: |
        # Check for either EMAIL_* or MAIL_* secrets (for compatibility)
        if [ -n "${{ secrets.MAIL_USERNAME }}" ] && [ -n "${{ secrets.MAIL_PASSWORD }}" ]; then
          echo "‚úÖ Email secrets configured (MAIL_USERNAME/MAIL_PASSWORD)"
        elif [ -n "${{ secrets.EMAIL_USERNAME }}" ] && [ -n "${{ secrets.EMAIL_PASSWORD }}" ]; then
          echo "‚úÖ Email secrets configured (EMAIL_USERNAME/EMAIL_PASSWORD)"
        else
          echo "‚ö†Ô∏è  Email secrets not configured. Skipping email notification."
          echo "üìß To enable email notifications, add ONE of these secret pairs:"
          echo "   Option 1 (matches your other repo):"
          echo "     - MAIL_USERNAME (your Gmail address)"
          echo "     - MAIL_PASSWORD (Gmail app-specific password)"
          echo "   Option 2:"
          echo "     - EMAIL_USERNAME (your Gmail address)"
          echo "     - EMAIL_PASSWORD (Gmail app-specific password)"
        fi
    
    - name: Send daily email notification
      if: always()
      continue-on-error: true
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        secure: true
        username: ${{ secrets.MAIL_USERNAME || secrets.EMAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD || secrets.EMAIL_PASSWORD }}
        subject: "‚ö° EVR Daily Action Plan + Portfolio Report"
        to: anshuman264@gmail.com
        from: EVR Scanner <${{ secrets.MAIL_USERNAME || secrets.EMAIL_USERNAME }}>
        html_body: |
          EVR Daily Portfolio Report & Action Plan
          
          Your daily portfolio scan is complete with actionable recommendations.
          
          ‚ö° RECOMMENDED ACTIONS (See attachment for details):
          
          üî¥ HIGH PRIORITY - Immediate action recommended
          üü° MEDIUM PRIORITY - Review within 1-2 days  
          üü¢ LOW PRIORITY - Monitor and consider
          
          The attached report contains:
          
          1Ô∏è‚É£ RECOMMENDED ACTIONS (AT THE TOP!)
             - Specific BUY/SELL instructions with share quantities
             - Entry prices, stops, and targets for new positions
             - Reasons for each recommendation (time exits, low returns, high EVR scores)
             - Priority levels for each action
          
          2Ô∏è‚É£ Portfolio Summary
             - Capital allocation, P&L, returns
          
          3Ô∏è‚É£ Open Positions
             - Current holdings with entry/stop/target and days held
          
          4Ô∏è‚É£ Recently Closed Positions
             - P&L by exit reason (time, stops, targets, replacements)
          
          5Ô∏è‚É£ Performance Statistics
             - Win rate, closed trades, profitability
          
          **üìã PLEASE REVIEW THE ATTACHED REPORT AND EXECUTE RECOMMENDED ACTIONS**
          
          Automated Analysis:
          ‚úÖ Portfolio monitored for time exits (7 days max hold)
          ‚úÖ Position replacement opportunities evaluated (20% threshold)
          ‚úÖ Stop losses and targets checked
          ‚úÖ New opportunities scanned and ranked by EVR score
          ‚úÖ Actionable buy/sell list generated with precise share counts
          
          Repository: https://github.com/${{ github.repository }}
          Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          Generated by EVR Scanner at 6:00 AM ET
        attachments: portfolio_report.txt
        
    - name: Create GitHub Issue on Failure
      if: failure()
      continue-on-error: true
      uses: actions/github-script@v7
      with:
        script: |
          try {
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `EVR Daily Scanner Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `The daily EVR scanner failed to run on ${new Date().toISOString().split('T')[0]}.
              
              **Workflow Details:**
              - Run ID: ${context.runId}
              - Run Number: ${context.runNumber}
              - Commit: ${context.sha}
              - Branch: ${context.ref}
              
              **Please check:**
              1. Scanner dependencies
              2. Network connectivity
              3. Data source availability
              4. GitHub Actions logs
              5. Email secrets configured
              
              **Workflow URL:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              This issue was automatically created by the EVR Scanner workflow.`,
              labels: ['bug', 'scanner', 'automation', 'daily']
            });
            
            console.log(`Created issue ${issue.data.number}: ${issue.data.title}`);
          } catch (error) {
            console.log(`Could not create issue (permissions may be required): ${error.message}`);
          }
          
    - name: Notify on Failure
      if: failure()
      continue-on-error: true
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        secure: true
        username: ${{ secrets.MAIL_USERNAME || secrets.EMAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD || secrets.EMAIL_PASSWORD }}
        subject: "üö® EVR Daily Scanner Failed - Run #${{ github.run_number }}"
        to: anshuman264@gmail.com
        from: EVR Scanner <${{ secrets.MAIL_USERNAME || secrets.EMAIL_USERNAME }}>
        html_body: |
          <h2>EVR Daily Scanner Failure Notification</h2>
          
          <p>The daily EVR scanner failed to run.</p>
          
          <h3>Details:</h3>
          <ul>
            <li>Run ID: ${{ github.run_id }}</li>
            <li>Run Number: ${{ github.run_number }}</li>
            <li>Commit: ${{ github.sha }}</li>
            <li>Branch: ${{ github.ref }}</li>
          </ul>
          
          <h3>Please check:</h3>
          <ol>
            <li>Scanner dependencies</li>
            <li>Network connectivity</li>
            <li>Data source availability</li>
            <li>GitHub Actions logs</li>
            <li>Email secrets (EMAIL_USERNAME, EMAIL_PASSWORD) are set</li>
          </ol>
          
          <p><strong>Workflow URL:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Logs</a></p>
          
          <hr>
          <p><em>Generated by EVR Scanner GitHub Action</em></p>