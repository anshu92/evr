name: Daily EVR Scanner

on:
  schedule:
    # Run daily at 6:00 AM ET (10:00 AM UTC during EDT, 11:00 AM UTC during EST)
    # Using 10:00 UTC to hit 6AM EDT (most of trading year: March-November)
    # During EST (winter), this will be 5AM ET, still before market open
    - cron: '0 10 * * 1-5'  # Monday to Friday at 10:00 AM UTC = 6:00 AM EDT
  workflow_dispatch:  # Allow manual trigger

jobs:
  daily-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-python-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-python-
    
    - name: Cache ticker data
      uses: actions/cache@v4
      with:
        path: |
          cache/
          trained_parameters/
        key: ${{ runner.os }}-evr-cache-${{ github.run_number }}
        restore-keys: |
          ${{ runner.os }}-evr-cache-
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: Install dependencies
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install pandas numpy pyarrow yfinance requests rich matplotlib jinja2 seaborn lxml html5lib
        uv pip install -e .
    
    - name: Check cache status
      run: |
        echo "Cache directories:"
        ls -lah cache/ 2>/dev/null || echo "No cache directory yet (will be created by scanner)"
        ls -lah trained_parameters/ 2>/dev/null || echo "No trained_parameters directory yet"
        echo ""
        echo "This workflow uses cache to persist:"
        echo "  - Ticker lists (cache/official_tickers.json, cache/delisted_tickers.json)"
        echo "  - Trained parameters (trained_parameters/)"
        echo "  - Python dependencies (.venv/)"
        
    - name: Run EVR Scanner
      run: |
        source .venv/bin/activate
        python official_scanner.py \
          --top 30 \
          --output-prefix "daily_$(date +%Y%m%d)" \
          --log-level INFO \
          --max-holding-days 7 \
          --enable-replacement \
          --replacement-threshold 0.20
        
    - name: Generate Summary Report
      run: |
        source .venv/bin/activate
        echo "EVR Daily Aggregated Trading Recommendations Report" > daily_summary.txt
        echo "Generated: $(date)" >> daily_summary.txt
        echo "Scan Date: $(date +%Y-%m-%d)" >> daily_summary.txt
        echo "" >> daily_summary.txt
        echo "SUMMARY STATISTICS:" >> daily_summary.txt
        echo "==================" >> daily_summary.txt
        echo "Daily scan completed successfully." >> daily_summary.txt
        echo "" >> daily_summary.txt
        echo "Files generated:" >> daily_summary.txt
        echo "- CSV with all aggregated recommendations" >> daily_summary.txt
        echo "- JSON with detailed data" >> daily_summary.txt
        echo "- Summary text file" >> daily_summary.txt
        echo "" >> daily_summary.txt
        echo "---" >> daily_summary.txt
        echo "Generated by EVR Scanner GitHub Action (Daily Schedule)" >> daily_summary.txt
        
    - name: Upload scan results
      uses: actions/upload-artifact@v4
      with:
        name: daily-scan-results-${{ github.run_number }}
        path: |
          scans/daily_*.csv
          scans/daily_*.json
          scans/daily_*.txt
          daily_summary.txt
        retention-days: 30
        
    - name: Send daily email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "EVR Daily Trading Signals - ${{ github.run_number }}"
        to: anshuman264@gmail.com
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          EVR Daily Trading Signals Report
          
          Daily scan completed successfully at ${{ github.run_number }}.
          
          **Scan Details:**
          - Date: $(date +%Y-%m-%d)
          - Top Recommendations: 30
          - Log Level: INFO
          
          Please find the detailed report in the attached summary file.
          
          Files generated:
          - CSV with all aggregated recommendations
          - JSON with detailed data
          - Summary text file
          
          Repository: https://github.com/${{ github.repository }}
          Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          Generated by EVR Scanner GitHub Action (Daily Schedule)
        attachments: daily_summary.txt
        content_type: text/html
        
    - name: Create GitHub Issue on Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `EVR Daily Scanner Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The daily EVR scanner failed to run on ${new Date().toISOString().split('T')[0]}.
            
            **Workflow Details:**
            - Run ID: ${context.runId}
            - Run Number: ${context.runNumber}
            - Commit: ${context.sha}
            - Branch: ${context.ref}
            
            **Please check:**
            1. Scanner dependencies
            2. Network connectivity
            3. Data source availability
            4. GitHub Actions logs
            
            **Workflow URL:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            This issue was automatically created by the EVR Scanner workflow.`,
            labels: ['bug', 'scanner', 'automation', 'daily']
          });
          
          console.log(`Created issue ${issue.data.number}: ${issue.data.title}`);
          
    - name: Notify on Failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "EVR Daily Scanner Failed - ${{ github.run_number }}"
        to: anshuman264@gmail.com
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          EVR Daily Scanner Failure Notification
          
          The daily EVR scanner failed to run.
          
          **Details:**
          - Run ID: ${{ github.run_id }}
          - Run Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref }}
          
          **Please check:**
          1. Scanner dependencies
          2. Network connectivity
          3. Data source availability
          4. GitHub Actions logs
          
          **Workflow URL:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          Generated by EVR Scanner GitHub Action
        content_type: text/html