name: Train Stock Screener Model (XGBoost)

on:
  schedule:
    # Run weekly on Sunday at 02:00 UTC (Saturday 9 PM ET / Sunday 10 PM ET)
    # Model is stable week-to-week; weekly retraining is sufficient
    # This ensures fresh model for Monday trading
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  train_model:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache universe/data/models
        uses: actions/cache@v4
        with:
          path: |
            cache/
            data_cache/
            models/
          key: ${{ runner.os }}-screener-model-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-screener-model-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Show system resources
        run: |
          echo "=== Memory ==="
          free -h
          echo "=== CPU ==="
          nproc
          echo "=== Disk ==="
          df -h
      
      - name: Train model
        env:
          MODEL_PATH: "models/ensemble/manifest.json"
          LABEL_HORIZON_DAYS: "5"
          # Full universe for better signal
          MAX_TICKERS: "4000"
          FEATURE_LOOKBACK_DAYS: "730"
          BATCH_SIZE: "250"
          # Quality filters â€” train only on investable stocks
          MIN_PRICE_CAD: "5.0"
          MIN_AVG_DOLLAR_VOLUME_CAD: "5000000"
          MAX_SCREEN_VOLATILITY: "0.80"
          # Optuna tuning (8 trials is sufficient; marginal gains diminish fast)
          OPTUNA_N_TRIALS: "8"
          OPTUNA_TIMEOUT_SECONDS: "120"
          # 2 XGB + 2 LightGBM = 4 diverse models (good quality/speed trade-off)
          ENSEMBLE_XGB_COUNT: "2"
          ENSEMBLE_LGBM_COUNT: "2"
        run: |
          python -m stock_screener.cli train-model --log-level INFO

      - name: Upload trained model artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: screener-model-${{ github.run_number }}
          path: |
            models/ensemble/
          retention-days: 90


