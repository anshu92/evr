name: Weekly EVR Scanner

on:
  schedule:
    # Run weekly on Mondays at 9:30 AM ET (2:30 PM UTC during EST, 1:30 PM UTC during EDT)
    # Using 13:30 UTC to cover both EST and EDT
    - cron: '30 13 * * 1'  # Monday at 1:30 PM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  weekly-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: Install dependencies
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install pandas numpy pyarrow yfinance requests rich matplotlib jinja2 seaborn lxml html5lib
        uv pip install -e .
        
    - name: Run Comprehensive EVR Scanner
      run: |
        source .venv/bin/activate
        python cli_official_scanner.py \
          --max-tickers 500 \
          --top 50 \
          --output-prefix "weekly_$(date +%Y%m%d)" \
          --log-level INFO
        
    - name: Generate Weekly Analysis Report
      run: |
        source .venv/bin/activate
        python -c "
        import pandas as pd
        import glob
        from datetime import datetime, timedelta
        import os
        
        # Find the latest CSV file
        files = glob.glob('scans/weekly_*.csv')
        if files:
            latest_file = max(files, key=lambda x: x.split('_')[-1])
            df = pd.read_csv(latest_file)
            
            # Generate comprehensive weekly report
            summary = f'''EVR Weekly Trading Signals Report
Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Week Ending: {datetime.now().strftime('%Y-%m-%d')}

WEEKLY SUMMARY STATISTICS:
==========================
Total Signals: {len(df)}
Long Positions: {len(df[df['direction'] == 'LONG'])} ({len(df[df['direction'] == 'LONG'])/len(df)*100:.1f}%)
Short Positions: {len(df[df['direction'] == 'SHORT'])} ({len(df[df['direction'] == 'SHORT'])/len(df)*100:.1f}%)
Average Confidence: {df['confidence'].mean():.1%}
Average Expected Return: {df['expected_return'].mean():.2%}
Average Risk/Reward Ratio: {df['risk_reward_ratio'].mean():.2f}

SIGNAL TYPE BREAKDOWN:
====================='''
            
            # Signal type breakdown
            signal_counts = df['signal_type'].value_counts()
            for signal_type, count in signal_counts.items():
                percentage = count / len(df) * 100
                avg_conf = df[df['signal_type'] == signal_type]['confidence'].mean()
                avg_return = df[df['signal_type'] == signal_type]['expected_return'].mean()
                summary += f'\n{signal_type}: {count} ({percentage:.1f}%) - Avg Confidence: {avg_conf:.1%}, Avg Return: {avg_return:.2%}'
            
            summary += f'''

TOP 20 SIGNALS BY EXPECTED RETURN:
=================================='''
            
            # Top 20 signals
            top_signals = df.nlargest(20, 'expected_return')
            for i, (_, signal) in enumerate(top_signals.iterrows(), 1):
                summary += f'\n{i:2d}. {signal[\"ticker\"]:6s} {signal[\"signal_type\"]:15s} {signal[\"direction\"]:5s} {signal[\"expected_return\"]:6.2%} ({signal[\"confidence\"]:5.1%}) R/R: {signal[\"risk_reward_ratio\"]:4.1f}'
            
            summary += f'''

RISK ANALYSIS:
==============
Average Risk: {df['risk_percentage'].mean():.1f}%
Average Reward: {df['reward_percentage'].mean():.1f}%
Risk Distribution:
  High Risk (>8%): {len(df[df['risk_percentage'] > 8])} ({len(df[df['risk_percentage'] > 8])/len(df)*100:.1f}%)
  Medium Risk (5-8%): {len(df[(df['risk_percentage'] >= 5) & (df['risk_percentage'] <= 8)])} ({len(df[(df['risk_percentage'] >= 5) & (df['risk_percentage'] <= 8)])/len(df)*100:.1f}%)
  Low Risk (<5%): {len(df[df['risk_percentage'] < 5])} ({len(df[df['risk_percentage'] < 5])/len(df)*100:.1f}%)

Reward Distribution:
  High Reward (>12%): {len(df[df['reward_percentage'] > 12])} ({len(df[df['reward_percentage'] > 12])/len(df)*100:.1f}%)
  Medium Reward (8-12%): {len(df[(df['reward_percentage'] >= 8) & (df['reward_percentage'] <= 12)])} ({len(df[(df['reward_percentage'] >= 8) & (df['reward_percentage'] <= 12)])/len(df)*100:.1f}%)
  Low Reward (<8%): {len(df[df['reward_percentage'] < 8])} ({len(df[df['reward_percentage'] < 8])/len(df)*100:.1f}%)

CONFIDENCE ANALYSIS:
===================
Confidence Distribution:
  High Confidence (>70%): {len(df[df['confidence'] > 0.7])} ({len(df[df['confidence'] > 0.7])/len(df)*100:.1f}%)
  Medium Confidence (50-70%): {len(df[(df['confidence'] >= 0.5) & (df['confidence'] <= 0.7)])} ({len(df[(df['confidence'] >= 0.5) & (df['confidence'] <= 0.7)])/len(df)*100:.1f}%)
  Low Confidence (<50%): {len(df[df['confidence'] < 0.5])} ({len(df[df['confidence'] < 0.5])/len(df)*100:.1f}%)

EXPECTED RETURN ANALYSIS:
========================
Return Distribution:
  High Return (>8%): {len(df[df['expected_return'] > 0.08])} ({len(df[df['expected_return'] > 0.08])/len(df)*100:.1f}%)
  Medium Return (5-8%): {len(df[(df['expected_return'] >= 0.05) & (df['expected_return'] <= 0.08)])} ({len(df[(df['expected_return'] >= 0.05) & (df['expected_return'] <= 0.08)])/len(df)*100:.1f}%)
  Low Return (<5%): {len(df[df['expected_return'] < 0.05])} ({len(df[df['expected_return'] < 0.05])/len(df)*100:.1f}%)

MARKET SENTIMENT:
================
Market Bias: {'Bullish' if len(df[df['direction'] == 'LONG']) > len(df[df['direction'] == 'SHORT']) else 'Bearish'}
Long/Short Ratio: {len(df[df['direction'] == 'LONG'])}/{len(df[df['direction'] == 'SHORT'])} ({len(df[df['direction'] == 'LONG'])/len(df[df['direction'] == 'SHORT']):.2f}:1)

Signal Quality Metrics:
  Signals with R/R > 2.0: {len(df[df['risk_reward_ratio'] > 2.0])} ({len(df[df['risk_reward_ratio'] > 2.0])/len(df)*100:.1f}%)
  Signals with R/R > 3.0: {len(df[df['risk_reward_ratio'] > 3.0])} ({len(df[df['risk_reward_ratio'] > 3.0])/len(df)*100:.1f}%)
  High Confidence + High Return: {len(df[(df['confidence'] > 0.7) & (df['expected_return'] > 0.08)])} ({len(df[(df['confidence'] > 0.7) & (df['expected_return'] > 0.08)])/len(df)*100:.1f}%)

FILES GENERATED:
===============
CSV: {latest_file}
JSON: {latest_file.replace('.csv', '.json')}
Summary: {latest_file.replace('.csv', '_summary.txt')}

---
Generated by EVR Scanner GitHub Action
Repository: https://github.com/anshuman264/evr
'''
            
            # Write summary to file
            with open('weekly_summary.txt', 'w') as f:
                f.write(summary)
                
            print('Weekly summary report generated successfully')
        else:
            print('No scan results found')
            with open('weekly_summary.txt', 'w') as f:
                f.write('EVR Weekly Trading Signals Report\nGenerated: ' + datetime.now().strftime('%Y-%m-%d %H:%M:%S') + '\n\nNo scan results found.\n\n---\nGenerated by EVR Scanner GitHub Action')
        "
        
    - name: Upload weekly scan results
      uses: actions/upload-artifact@v4
      with:
        name: weekly-scan-results-${{ github.run_number }}
        path: |
          scans/weekly_*.csv
          scans/weekly_*.json
          scans/weekly_*.txt
          weekly_summary.txt
        retention-days: 90
        
    - name: Send weekly email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "EVR Weekly Trading Signals - ${{ github.run_number }}"
        to: anshuman264@gmail.com
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          EVR Weekly Trading Signals Report
          
          Weekly comprehensive scan completed successfully at ${{ github.run_number }}.
          
          This report includes:
          - Comprehensive market analysis
          - Top 20 signals by expected return
          - Detailed risk and confidence analysis
          - Market sentiment indicators
          - Signal quality metrics
          
          Please find the detailed report in the attached summary file.
          
          Files generated:
          - CSV with all signals
          - JSON with detailed data
          - Summary text file
          
          Repository: https://github.com/${{ github.repository }}
          Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          Generated by EVR Scanner GitHub Action
        attachments: weekly_summary.txt
        content_type: text/html
        
    - name: Create GitHub Issue on Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `EVR Weekly Scanner Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The weekly EVR scanner failed to run on ${new Date().toISOString().split('T')[0]}.
            
            **Workflow Details:**
            - Run ID: ${context.runId}
            - Run Number: ${context.runNumber}
            - Commit: ${context.sha}
            - Branch: ${context.ref}
            
            **Please check:**
            1. Scanner dependencies
            2. Network connectivity
            3. Data source availability
            4. GitHub Actions logs
            
            **Workflow URL:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            This issue was automatically created by the EVR Scanner workflow.`,
            labels: ['bug', 'scanner', 'automation', 'weekly']
          });
          
          console.log(`Created issue ${issue.data.number}: ${issue.data.title}`);
          
    - name: Notify on Failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "EVR Weekly Scanner Failed - ${{ github.run_number }}"
        to: anshuman264@gmail.com
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          EVR Weekly Scanner Failure Notification
          
          The weekly EVR scanner failed to run.
          
          **Details:**
          - Run ID: ${{ github.run_id }}
          - Run Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref }}
          
          **Please check:**
          1. Scanner dependencies
          2. Network connectivity
          3. Data source availability
          4. GitHub Actions logs
          
          **Workflow URL:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          Generated by EVR Scanner GitHub Action
        content_type: text/html
