name: Daily Stock Screener (CAD) + Email

on:
  schedule:
    # Run 3x per WEEKDAY (Mon-Fri) for timely trading signals.
    # NYSE hours: 9:30 AM - 4:00 PM ET.
    # Times chosen so the email arrives with enough time to act in BOTH
    # winter (EST = UTC-5) and summer (EDT = UTC-4).
    #
    #                          EST (winter)     EDT (summer)
    # ─────────────────────────────────────────────────────────
    # PRE-MARKET  12:00 UTC    7:00 AM (-2.5h)  8:00 AM (-1.5h)
    # MID-DAY     15:00 UTC   10:00 AM (+0.5h) 11:00 AM (+1.5h)
    # PRE-CLOSE   19:30 UTC    2:30 PM (-1.5h)  3:30 PM (-0.5h)
    #
    # Pipeline takes ~5-10 min, so emails arrive well before the action window.

    # PRE-MARKET: 12:00 UTC — review + place orders before 9:30 AM open
    - cron: '0 12 * * 1-5'

    # MID-DAY: 15:00 UTC — after opening volatility settles (~30-90 min in)
    - cron: '0 15 * * 1-5'

    # PRE-CLOSE: 19:30 UTC — last chance for end-of-day positioning
    - cron: '30 19 * * 1-5'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  daily_screener:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache universe/data
        uses: actions/cache@v4
        with:
          path: |
            cache/
            data_cache/
            screener_portfolio_state.json
          key: ${{ runner.os }}-daily-screener-data-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-daily-screener-data-

      - name: Cache ML model
        uses: actions/cache@v4
        with:
          path: |
            models/
          key: ${{ runner.os }}-screener-model-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-screener-model-

      - name: Find latest trained model artifact
        id: model_artifact
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const workflow_id = "train-stock-screener-model.yml";
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id,
              status: "success",
              per_page: 5,
            });
            for (const run of runs.data.workflow_runs) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: run.id,
              });
              const match = artifacts.data.artifacts.find(
                (artifact) => artifact.name.startsWith("screener-model-") && !artifact.expired
              );
              if (match) {
                core.setOutput("artifact_id", String(match.id));
                core.setOutput("artifact_name", match.name);
                core.setOutput("run_id", String(run.id));
                return;
              }
            }
            core.setOutput("artifact_id", "");
            core.setOutput("artifact_name", "");
            core.setOutput("run_id", "");

      - name: Download latest trained model
        if: steps.model_artifact.outputs.artifact_id != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Found model: ${{ steps.model_artifact.outputs.artifact_name }} (run ${{ steps.model_artifact.outputs.run_id }})"
          rm -rf models/ensemble/

          # download-artifact@v4 cannot fetch artifacts from other workflow runs.
          # Use the REST API directly instead (gh cli handles auth + redirects).
          gh api "repos/${{ github.repository }}/actions/artifacts/${{ steps.model_artifact.outputs.artifact_id }}/zip" > /tmp/model.zip
          unzip -o /tmp/model.zip -d /tmp/model-extract

          # Handle both possible structures:
          #   a) artifact preserves workspace-relative path: models/ensemble/*
          #   b) artifact contains files at root: manifest.json, *.json, *.bin
          if [ -d "/tmp/model-extract/models/ensemble" ]; then
            mv /tmp/model-extract/models/ensemble models/ensemble
          elif [ -f "/tmp/model-extract/manifest.json" ]; then
            mkdir -p models/ensemble
            mv /tmp/model-extract/* models/ensemble/
          else
            echo "WARNING: Unexpected artifact structure:"
            find /tmp/model-extract -type f | head -20
            mkdir -p models/ensemble
          fi

          rm -rf /tmp/model.zip /tmp/model-extract
          echo "Model files downloaded:"
          ls -la models/ensemble/ 2>/dev/null || echo "No model files found"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure ML model exists (train if missing)
        shell: bash
        env:
          MODEL_PATH: "models/ensemble/manifest.json"
          LABEL_HORIZON_DAYS: "5"
          # Lightweight fallback — just enough for a usable model.
          MAX_TICKERS: "1500"
          FEATURE_LOOKBACK_DAYS: "365"
          BATCH_SIZE: "200"
          # Disable Optuna and use minimal ensemble for speed
          USE_OPTUNA: "0"
          ENSEMBLE_XGB_COUNT: "2"
          ENSEMBLE_LGBM_COUNT: "1"
          # Quality filters — must match daily screener and full training
          MIN_PRICE_CAD: "5.0"
          MIN_AVG_DOLLAR_VOLUME_CAD: "5000000"
          MAX_SCREEN_VOLATILITY: "0.80"
        run: |
          if [ -f "$MODEL_PATH" ]; then
            echo "Model manifest found at $MODEL_PATH"
          else
            echo "Model manifest missing; training a fallback model..."
            python -m stock_screener.cli train-model --log-level INFO
          fi

      - name: Run daily screener
        env:
          # Safety default to avoid runaway runs; you can override in repo variables if desired.
          MAX_TICKERS: "4000"
          TOP_N: "50"
          PORTFOLIO_SIZE: "5"
          PORTFOLIO_BUDGET_CAD: "500"
          WEIGHT_CAP: "0.10"
          MIN_PRICE_CAD: "5.0"
          MIN_AVG_DOLLAR_VOLUME_CAD: "5000000"
          MAX_SCREEN_VOLATILITY: "0.80"
          # Entry quality filters (always on)
          ENTRY_MIN_CONFIDENCE: "0.5"
          ENTRY_MIN_PRED_RETURN: "0.01"
          ENTRY_MAX_VOLATILITY: "0.60"
          ENTRY_MIN_MOMENTUM_5D: "-0.05"
          # Use SOTA ML by default. If no model is present, the pipeline auto-falls back to baseline scoring.
          USE_ML: "1"
          MODEL_PATH: "models/ensemble/manifest.json"
          # Quick-compounding: sell at predicted peak, redeploy capital fast
          MAX_HOLDING_DAYS: "3"
          MAX_HOLDING_DAYS_HARD: "5"
          QUICK_PROFIT_PCT: "0.03"
          QUICK_PROFIT_DAYS: "2"
          MIN_DAILY_RETURN: "0.008"
          PORTFOLIO_STATE_PATH: "screener_portfolio_state.json"
          # Peak detection and partial exit settings
          PEAK_DETECTION_ENABLED: "1"
          PEAK_SELL_PORTION_PCT: "0.50"
          PEAK_MIN_GAIN_PCT: "0.04"
          PEAK_MIN_HOLDING_DAYS: "2"
          PEAK_PRED_RETURN_THRESHOLD: "-0.02"
          PEAK_SCORE_PERCENTILE_DROP: "0.30"
          PEAK_RSI_OVERBOUGHT: "70.0"
          PEAK_ABOVE_MA_RATIO: "0.15"
        run: |
          python -m stock_screener.cli daily --log-level INFO

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-stock-screener-${{ github.run_number }}
          path: |
            reports/
            cache/last_run_meta.json
            screener_portfolio_state.json
          retention-days: 30

      - name: Determine market session
        id: session
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" -lt 13 ]; then
            echo "session=Pre-Market" >> $GITHUB_OUTPUT
          elif [ "$HOUR" -lt 17 ]; then
            echo "session=Mid-Day" >> $GITHUB_OUTPUT
          else
            echo "session=Pre-Close" >> $GITHUB_OUTPUT
          fi

      - name: Send daily email
        if: always()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[${{ steps.session.outputs.session }}] Stock Screener + Portfolio (CAD)"
          to: ${{ secrets.EMAIL_TO || secrets.EMAIL_USERNAME }}
          from: Stock Screener Bot <${{ secrets.EMAIL_USERNAME }}>
          html_body: file://reports/daily_email.html
          attachments: reports/daily_report.txt,reports/portfolio_weights.csv,reports/trade_actions.json

      - name: Create GitHub Issue on Failure
        if: failure()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Daily Stock Screener Failed - ${new Date().toISOString().split('T')[0]}`,
                body: `The daily stock screener failed.\n\n**Workflow URL:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\nPlease check the run logs for details.`,
                labels: ['bug', 'automation', 'screener']
              });
              console.log(`Created issue ${issue.data.number}`);
            } catch (error) {
              console.log(`Could not create issue: ${error.message}`);
            }


