name: Daily Stock Screener (CAD) + Email

on:
  schedule:
    - cron: '0 10 * * 1-5' # Weekdays 10:00 UTC ~= 6:00 AM EDT / 5:00 AM EST
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  daily_screener:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache universe/data
        uses: actions/cache@v4
        with:
          path: |
            cache/
            data_cache/
            screener_portfolio_state.json
          key: ${{ runner.os }}-daily-screener-data-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-daily-screener-data-

      - name: Cache ML model
        uses: actions/cache@v4
        with:
          path: |
            models/
          key: ${{ runner.os }}-screener-model-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-screener-model-

      - name: Find latest trained model artifact
        id: model_artifact
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const workflow_id = "train-stock-screener-model.yml";
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id,
              status: "success",
              per_page: 5,
            });
            for (const run of runs.data.workflow_runs) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: run.id,
              });
              const match = artifacts.data.artifacts.find(
                (artifact) => artifact.name.startsWith("screener-model-") && !artifact.expired
              );
              if (match) {
                core.setOutput("artifact_id", String(match.id));
                core.setOutput("artifact_name", match.name);
                core.setOutput("run_id", String(run.id));
                return;
              }
            }
            core.setOutput("artifact_id", "");
            core.setOutput("artifact_name", "");
            core.setOutput("run_id", "");

      - name: Download latest trained model
        if: steps.model_artifact.outputs.artifact_id != ''
        run: |
          echo "Found latest model artifact: ${{ steps.model_artifact.outputs.artifact_name }} from run ${{ steps.model_artifact.outputs.run_id }}"
          echo "Clearing cached model to use latest..."
          rm -rf models/ensemble/
          mkdir -p models/ensemble/

      - name: Download artifact
        if: steps.model_artifact.outputs.artifact_id != ''
        uses: actions/download-artifact@v4
        with:
          artifact-id: ${{ steps.model_artifact.outputs.artifact_id }}
          path: .

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure ML model exists (train if missing)
        shell: bash
        env:
          MODEL_PATH: "models/ensemble/manifest.json"
          LABEL_HORIZON_DAYS: "5"
          # Keep this lighter than the dedicated training workflow; it's only a fallback.
          MAX_TICKERS: "1500"
          FEATURE_LOOKBACK_DAYS: "365"
          BATCH_SIZE: "200"
        run: |
          if [ -f "$MODEL_PATH" ]; then
            echo "Model manifest found at $MODEL_PATH"
          else
            echo "Model manifest missing; training a fallback model..."
            python -m stock_screener.cli train-model --log-level INFO
          fi

      - name: Run daily screener
        env:
          # Safety default to avoid runaway runs; you can override in repo variables if desired.
          MAX_TICKERS: "4000"
          TOP_N: "50"
          PORTFOLIO_SIZE: "5"
          PORTFOLIO_BUDGET_CAD: "500"
          WEIGHT_CAP: "0.10"
          MIN_PRICE_CAD: "2.0"
          MIN_AVG_DOLLAR_VOLUME_CAD: "250000"
          # Use SOTA ML by default. If no model is present, the pipeline auto-falls back to baseline scoring.
          USE_ML: "1"
          MODEL_PATH: "models/ensemble/manifest.json"
          # Short-horizon trading goal
          MAX_HOLDING_DAYS: "5"
          MAX_HOLDING_DAYS_HARD: "10"
          # If the model is very confident, allow holding beyond 5 days up to the hard cap.
          EXTEND_HOLD_MIN_PRED_RETURN: "0.03"
          PORTFOLIO_STATE_PATH: "screener_portfolio_state.json"
        run: |
          python -m stock_screener.cli daily --log-level INFO

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-stock-screener-${{ github.run_number }}
          path: |
            reports/
            cache/last_run_meta.json
            screener_portfolio_state.json
          retention-days: 30

      - name: Send daily email
        if: always()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Daily Stock Screener + Portfolio Weights (CAD)"
          to: ${{ secrets.EMAIL_TO || secrets.EMAIL_USERNAME }}
          from: Stock Screener Bot <${{ secrets.EMAIL_USERNAME }}>
          html_body: file://reports/daily_email.html
          attachments: reports/daily_report.txt,reports/portfolio_weights.csv,reports/trade_actions.json

      - name: Create GitHub Issue on Failure
        if: failure()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Daily Stock Screener Failed - ${new Date().toISOString().split('T')[0]}`,
                body: `The daily stock screener failed.\n\n**Workflow URL:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\nPlease check the run logs for details.`,
                labels: ['bug', 'automation', 'screener']
              });
              console.log(`Created issue ${issue.data.number}`);
            } catch (error) {
              console.log(`Could not create issue: ${error.message}`);
            }


